{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lista de Productos</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <!-- Tu CSS -->
  <link rel="stylesheet" href="{% static 'css/lista.css' %}">
<!-- CSS propio -->
  <link rel="stylesheet" href="{% static 'css/cssbase.css' %}">
  <!-- SweetAlert -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>

  <!-- NAVBAR (igual estilo que el home) -->
   <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg" style="background-color:#5de080">
    <div class="container-fluid">
      <a class="navbar-brand d-lg-none" href="#"><img src="{% static 'images/Logo.png' %}" style="border-radius:20px;height:120px;" alt=""></a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarScroll">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarScroll">
        <ul class="navbar-nav me-auto my-2 my-lg-0 navbar-nav-scroll mx-auto" style="--bs-scroll-height:100px;">
          <li class="nav-item"><a class="nav-link active" href="{% url 'home' %}">Inicio</a></li>
          <li class="nav-item"><a class="nav-link active" href="#">Contacto</a></li>

          {% if user.is_authenticated %}
            <li class="nav-item"><a class="nav-link" href="{% url 'agregar_producto' %}">Agregar Producto</a></li>
          {% endif %}

          <a class="navbar-brand d-none d-lg-block" href="#"><img src="{% static 'images/Logo.png' %}" style="border-radius:20px;height:120px;" alt=""></a>

          {% if user.is_authenticated %}
            <li class="nav-item"><a class="nav-link" href="{% url 'listar-productos' %}">Listar Productos</a></li>
          {% endif %}

          <li class="nav-item"><a class="nav-link" href="#">Consejos</a></li>

          {% if user.is_authenticated %}
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">Opciones</a>
              <ul class="dropdown-menu">
                <li>
                  <a class="dropdown-item" href="{% url 'inbox' %}">
                    <i class="bi bi-envelope me-1"></i>Inbox {{ user.username }}
                    {% if notificaciones_no_leidas > 0 %}
                      <span class="badge bg-danger" id="notification-badge">{{ notificaciones_no_leidas }}</span>
                    {% endif %}
                  </a>
                </li>
                <li>
                  <form id="logout-form" method="post" action="{% url 'logout' %}">{% csrf_token %}
                    <button type="submit" class="dropdown-item">Cerrar sesión</button>
                  </form>
                </li>
              </ul>
            </li>
          {% else %}
            <li class="nav-item"><a class="nav-link" href="{% url 'login' %}">Iniciar sesión</a></li>
          {% endif %}
        </ul>
      </div>
    </div>
  </nav>

  <div class="container py-4">
    <h2 class="mb-3">Lista de Productos</h2>

    <!-- Barra de búsqueda (si no llegan filtros, igual renderiza) -->
    <div class="search-bar-container mb-4">
      <div class="search-bar">
        <form class="d-flex flex-wrap gap-2 align-items-center" method="GET" action="{% url 'listar-productos' %}" role="search">
          <input class="form-control" style="min-width:200px" type="search" name="query" placeholder="Buscar productos" aria-label="Buscar" value="{{ query|default_if_none:'' }}">

          <select class="form-select" name="tipo">
            <option value="">Todos los tipos</option>
            {% if tipos %}
              {% for t in tipos %}
                <option value="{{ t.id }}" {% if t.id|stringformat:"s" == tipo_seleccionado %}selected{% endif %}>{{ t.tipo_objeto }}</option>
              {% endfor %}
            {% endif %}
          </select>

          <select class="form-select" name="ubicacion">
            <option value="">Todas las regiones</option>
            {% if ubicaciones %}
              {% for u in ubicaciones %}
                <option value="{{ u.id }}" {% if u.id|stringformat:"s" == ubicacion_seleccionada %}selected{% endif %}>{{ u.ubicacion_name }}</option>
              {% endfor %}
            {% endif %}
          </select>

          <button class="btn btn-success" type="submit">
            <i class="bi bi-search"></i> Buscar
          </button>
        </form>
      </div>
    </div>

    <!-- Lista en tarjetas -->
    {% if entity %}
      <div class="row g-3">
        {% for producto in entity %}
          <div class="col-md-4">
            <div class="card h-100">
              {% if producto.imagen %}
                <img src="{{ producto.imagen.url }}" class="card-img-top" alt="{{ producto.nombre }}">
              {% endif %}
              <div class="card-body d-flex flex-column">
                <h5 class="card-title">{{ producto.nombre }}</h5>
                <p class="mb-1 text-muted"><strong>Estado:</strong> {{ producto.estado }}</p>
                <p class="mb-1 text-muted"><strong>Color:</strong> {{ producto.color }}</p>
                <p class="mb-1 text-muted"><strong>Tipo:</strong> {{ producto.tipo }}</p>
                <p class="mb-1 text-muted"><strong>Ubicación:</strong> {{ producto.ubicacion }}</p>
                <p class="mb-3 text-muted"><strong>Fecha de Publicación:</strong> {{ producto.fecha_publicacion }}</p>

                <div class="mt-auto d-flex gap-2">
                  <a href="{% url 'modificar-producto' producto.id %}" class="btn btn-outline-secondary flex-fill">
                    <i class="bi bi-pencil-square me-1"></i>Editar
                  </a>
                  <button class="btn btn-outline-danger flex-fill" onclick="eliminarProducto({{ producto.id|safe }})">
                    <i class="bi bi-trash me-1"></i>Eliminar
                  </button>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

    {% else %}
      <div class="alert alert-info mt-3">No se encontraron productos.</div>
    {% endif %}

    <!-- Paginación -->
    <div class="mt-4">
      {% include 'app/paginator.html' %}
    </div>

    <div class="d-flex justify-content-center gap-2 mt-3">
      <a href="{% url 'agregar_producto' %}" class="btn btn-success">Agregar Producto</a>
      <a href="{% url 'home' %}" class="btn btn-outline-secondary">Volver al Home</a>
    </div>
  </div>
  <!-- ===== Olas + Copyright verde (estilos de olas están en cssbase.css) ===== -->
  <section class="container-waves">
    <div class="wave wave1"></div>
    <div class="wave wave2"></div>
    <div class="wave wave3"></div>
    <div class="wave wave4"></div>
  </section>

  <div class="text-center p-4" style="background:#5de080;">
    © 2024 Copyright:
    <a class="text-reset fw-bold" href="https://mdbootstrap.com/">EcoIntercambio.com</a>
  </div>

  <script>
    function eliminarProducto(id){
      Swal.fire({
        title: "¿Estás seguro?",
        text: "Esta acción no se puede deshacer",
        icon: "warning",
        showCancelButton: true,
        cancelButtonText: "No, cancelar",
        confirmButtonText: "Sí, eliminar",
        confirmButtonColor: "#dc3545"
      }).then(function(result){
        if(result.isConfirmed){
          window.location.href = "/eliminar-producto/" + id + "/";
        }
      });
    }
  </script>

</body>
</html>
